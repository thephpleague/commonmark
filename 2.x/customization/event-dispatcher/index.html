<h1 id="event-dispatcher">Event Dispatcher</h1>

<p>This library includes basic, <a href="https://www.php-fig.org/psr/psr-14/">PSR-14</a>-compliant event dispatcher functionality.  This makes it possible to add hook points throughout the library and third-party extensions which other code can listen for and execute code.</p>

<h2 id="event-class">Event Class</h2>

<p>Any <a href="https://www.php-fig.org/psr/psr-14/#events">PSR-14 compliant event</a> can be used, though we also provide an <code class="language-plaintext highlighter-rouge">AbstractEvent</code> class you can use to easily create your own events:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">League\CommonMark\Event\AbstractEvent</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyCustomEvent</span> <span class="kd">extends</span> <span class="nc">AbstractEvent</span> <span class="p">{}</span>
</code></pre></div></div>

<p>An event can have any number of methods on it which return useful information the listeners can use or modify.</p>

<h2 id="registering-listeners">Registering Listeners</h2>

<p>Listeners can be registered with the <code class="language-plaintext highlighter-rouge">Environment</code> using the <code class="language-plaintext highlighter-rouge">addEventListener()</code> method:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">addEventListener</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$eventClass</span><span class="p">,</span> <span class="kt">callable</span> <span class="nv">$listener</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>The parameters for this method are:</p>

<ol>
  <li>The fully-qualified name of the event class you wish to observe</li>
  <li>Any <a href="https://www.php.net/manual/en/language.types.callable.php">PHP callable</a> to execute when that type of event is dispatched</li>
  <li>An optional priority (defaults to <code class="language-plaintext highlighter-rouge">0</code>)</li>
</ol>

<p>For example:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Telling the environment which method to call:</span>
<span class="nv">$customListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCustomListener</span><span class="p">();</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="nf">addEventListener</span><span class="p">(</span><span class="nc">MyCustomEvent</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="p">[</span><span class="nv">$customListener</span><span class="p">,</span> <span class="s1">'onDocumentParsed'</span><span class="p">]);</span>

<span class="c1">// Or if MyCustomerListener has an __invoke() method:</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="nf">addEventListener</span><span class="p">(</span><span class="nc">MyCustomEvent</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">new</span> <span class="nc">MyCustomListener</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// Or use any other type of callable you wish!</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="nf">addEventListener</span><span class="p">(</span><span class="nc">MyCustomEvent</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">MyCustomEvent</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO: Stuff</span>
<span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="dispatching-events">Dispatching Events</h2>

<p>Events can be dispatched via the <code class="language-plaintext highlighter-rouge">$environment-&gt;dispatch()</code> method which takes a single argument - the event object to dispatch:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$environment</span><span class="o">-&gt;</span><span class="nf">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyCustomEvent</span><span class="p">());</span>
</code></pre></div></div>

<p>Listeners will be called in order of priority (higher priorities will be called first).  If multiple listeners have the same priority, they’ll be called in the order in which they were registered.  If you’d like your listener to prevent other subsequent events from running, simply call <code class="language-plaintext highlighter-rouge">$event-&gt;stopPropagation()</code>.</p>

<p>Listeners may call any method on the event to get more information about the event, make changes to event data, etc.</p>

<h2 id="list-of-available-events">List of Available Events</h2>

<p>This library supports the following default events which you can register listeners for:</p>

<h3 id="leaguecommonmarkeventdocumentpreparsedevent"><code class="language-plaintext highlighter-rouge">League\CommonMark\Event\DocumentPreParsedEvent</code></h3>

<p>This event is dispatched just before any processing is done. It can be used to pre-populate reference map of a document or manipulate the Markdown contents before any processing is performed.</p>

<h3 id="leaguecommonmarkeventdocumentparsedevent"><code class="language-plaintext highlighter-rouge">League\CommonMark\Event\DocumentParsedEvent</code></h3>

<p>This event is dispatched once all other processing is done.  This offers extensions the opportunity to inspect and modify the <a href="/2.x/customization/abstract-syntax-tree/">Abstract Syntax Tree</a> prior to rendering.</p>

<h3 id="leaguecommonmarkeventdocumentprerenderevent"><code class="language-plaintext highlighter-rouge">League\CommonMark\Event\DocumentPreRenderEvent</code></h3>

<p>This event is dispatched by the renderer just before rendering begins.  Like with <code class="language-plaintext highlighter-rouge">DocumentParsedEvent</code>, this offers extensions the opportunity to inspect and modify the <a href="/2.x/customization/abstract-syntax-tree/">Abstract Syntax Tree</a> prior to rendering, but with the added knowledge of which format is being rendered to (e.g. <code class="language-plaintext highlighter-rouge">html</code>).</p>

<h3 id="leaguecommonmarkeventdocumentrenderedevent"><code class="language-plaintext highlighter-rouge">League\CommonMark\Event\DocumentRenderedEvent</code></h3>

<p>This event is dispatched once the rendering step has been completed, just before the output is returned.  The final output can be adjusted at this point or additional metadata can be attached to the return object.</p>

<h2 id="bring-your-own-psr-14-event-dispatcher">Bring Your Own PSR-14 Event Dispatcher</h2>

<p>Although this library provides PSR-14 compliant event dispatching out-of-the-box, you may want to use your own PSR-14 event dispatcher instead.  This is possible as long as that third-party library both:</p>

<ol>
  <li>Implements the PSR-14 <code class="language-plaintext highlighter-rouge">EventDispatcherInterface</code>; and,</li>
  <li>Allows you to register additional <code class="language-plaintext highlighter-rouge">ListenerProviderInterface</code> instances with that dispatcher library</li>
</ol>

<p>Not all libraries support this so please check carefully!  Assuming yours does, delegating all the event behavior to that library can be done with two steps:</p>

<p>First, call the <code class="language-plaintext highlighter-rouge">setEventDispatcher()</code> method on the <code class="language-plaintext highlighter-rouge">Environment</code> to register that other implementation.  With that done, any calls to <code class="language-plaintext highlighter-rouge">Environment::dispatch()</code> will be passed through to that other dispatcher.  But we still need to let that dispatcher know about the events registered by CommonMark extensions, otherwise nothing will happen when events are dispatched.</p>

<p>Because the <code class="language-plaintext highlighter-rouge">Environment</code> implements PSR-14’s <code class="language-plaintext highlighter-rouge">ListenerProviderInterface</code> you’ll also need to pass the configured <code class="language-plaintext highlighter-rouge">Environment</code> object to your event dispatcher so that it becomes aware of those available events.</p>

<h2 id="example">Example</h2>

<p>Here’s an example of a listener which uses the <code class="language-plaintext highlighter-rouge">DocumentParsedEvent</code> to add an <code class="language-plaintext highlighter-rouge">external-link</code> class to external URLs:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">League\CommonMark\Environment\EnvironmentInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">League\CommonMark\Event\DocumentParsedEvent</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">League\CommonMark\Extension\CommonMark\Node\Inline\Link</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ExternalLinkProcessor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$environment</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">EnvironmentInterface</span> <span class="nv">$environment</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">environment</span> <span class="o">=</span> <span class="nv">$environment</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onDocumentParsed</span><span class="p">(</span><span class="kt">DocumentParsedEvent</span> <span class="nv">$event</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$document</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="nf">getDocument</span><span class="p">();</span>
        <span class="nv">$walker</span> <span class="o">=</span> <span class="nv">$document</span><span class="o">-&gt;</span><span class="nf">walker</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$event</span> <span class="o">=</span> <span class="nv">$walker</span><span class="o">-&gt;</span><span class="nb">next</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="nf">getNode</span><span class="p">();</span>

            <span class="c1">// Only stop at Link nodes when we first encounter them</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">Link</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="nf">isEntering</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">isUrlExternal</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="nf">append</span><span class="p">(</span><span class="s1">'attributes/class'</span><span class="p">,</span> <span class="s1">'external-link'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">isUrlExternal</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$url</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="c1">// Only look at http and https URLs</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^https?:\/\//'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$host</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="kc">PHP_URL_HOST</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$host</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">environment</span><span class="o">-&gt;</span><span class="nf">getConfiguration</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'host'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s how you’d use it:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">League\CommonMark\CommonMarkConverter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">League\CommonMark\Environment\Environment</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">League\CommonMark\Event\DocumentParsedEvent</span><span class="p">;</span>

<span class="nv">$env</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Environment</span><span class="p">();</span>

<span class="nv">$listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExternalLinkProcessor</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
<span class="nv">$env</span><span class="o">-&gt;</span><span class="nf">addEventListener</span><span class="p">(</span><span class="nc">DocumentParsedEvent</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="p">[</span><span class="nv">$listener</span><span class="p">,</span> <span class="s1">'onDocumentParsed'</span><span class="p">]);</span>

<span class="nv">$converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommonMarkConverter</span><span class="p">([</span><span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'commonmark.thephpleague.com'</span><span class="p">],</span> <span class="nv">$env</span><span class="p">);</span>

<span class="nv">$input</span> <span class="o">=</span> <span class="s1">'My two favorite sites are &lt;https://google.com&gt; and &lt;https://commonmark.thephpleague.com&gt;'</span><span class="p">;</span>

<span class="k">echo</span> <span class="nv">$converter</span><span class="o">-&gt;</span><span class="nf">convert</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>
</code></pre></div></div>

<p>Output (formatted for readability):</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>
    My two favorite sites are
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"external-link"</span> <span class="na">href=</span><span class="s">"https://google.com"</span><span class="nt">&gt;</span>https://google.com<span class="nt">&lt;/a&gt;</span>
    and
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://commonmark.thephpleague.com"</span><span class="nt">&gt;</span>https://commonmark.thephpleague.com<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>
